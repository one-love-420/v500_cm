<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"><html><head><title>drivers/video/msm/mipi_dsi_panel_common.c - kernel/msm - Git at Google</title><link rel="stylesheet" type="text/css" href="//www.google.com/css/go.css" /><link rel="stylesheet" type="text/css" href="/+static/prettify/prettify.vf-M93Ay4IiiWRQSJKPGWQ.cache.css" /><link rel="stylesheet" type="text/css" href="/+static/gitiles.NflJW88ZoV70lY6sErU9Rw.cache.css" /></head><body><h1><img src="//www.google.com/images/logo_sm.gif" alt="Google" />Git</h1><div class="menu"> <a href="https://www.google.com/a/SelectSession?service=gerritcodereview&amp;continue=https://android.googlesource.com/login/kernel/msm/%2B/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video/msm/mipi_dsi_panel_common.c">Sign in</a> </div><div class="breadcrumbs"><a href="/?format=HTML">android</a> / <a href="/kernel/msm/">kernel/msm</a> / <a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8">3c9050f365927cef4a317f0944209ca2561296a8</a> / <a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8/">.</a> / <a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8/drivers">drivers</a> / <a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video">video</a> / <a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video/msm">msm</a> / mipi_dsi_panel_common.c</div><div class="sha1">blob: 0358048c0d52bd1c16ca5d79c62b455d540bd90a [<a href="/kernel/msm/+/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video/msm/mipi_dsi_panel_common.c">file</a>] [<a href="/kernel/msm/+log/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video/msm/mipi_dsi_panel_common.c">log</a>] [<a href="/kernel/msm/+blame/3c9050f365927cef4a317f0944209ca2561296a8/drivers/video/msm/mipi_dsi_panel_common.c">blame</a>]</div><ol class="prettyprint"><li><a name="1"></a><span class="com">/* drivers/video/msm/mipi_dsi_panel_common.c</span></li><li><a name="2"></a><span class="com"> *</span></li><li><a name="3"></a><span class="com"> * Copyright (C) [2011] Sony Ericsson Mobile Communications AB.</span></li><li><a name="4"></a><span class="com"> *</span></li><li><a name="5"></a><span class="com"> * This program is free software; you can redistribute it and/or modify</span></li><li><a name="6"></a><span class="com"> * it under the terms of the GNU General Public License version 2; as</span></li><li><a name="7"></a><span class="com"> * published by the Free Software Foundation; either version 2</span></li><li><a name="8"></a><span class="com"> * of the License, or (at your option) any later version.</span></li><li><a name="9"></a><span class="com"> */</span></li><li><a name="10"></a></li><li><a name="11"></a><span class="com">#include</span><span class="pln"> </span><span class="str">&quot;msm_fb.h&quot;</span></li><li><a name="12"></a><span class="com">#include</span><span class="pln"> </span><span class="str">&quot;mipi_dsi.h&quot;</span></li><li><a name="13"></a><span class="com">#include</span><span class="pln"> </span><span class="str">&quot;mipi_dsi_panel.h&quot;</span></li><li><a name="14"></a></li><li><a name="15"></a><span class="kwd">void</span><span class="pln"> mipi_dsi_set_default_panel</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">)</span></li><li><a name="16"></a><span class="pun">{</span></li><li><a name="17"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li><a name="18"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li><a name="19"></a><span class="pln">	</span><span class="kwd">else</span></li><li><a name="20"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">panels</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></li><li><a name="21"></a></li><li><a name="22"></a><span class="pln">	MSM_FB_INFO</span><span class="pun">(</span><span class="str">&quot;default panel: %s\n&quot;</span><span class="pun">,</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">name</span><span class="pun">);</span></li><li><a name="23"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info </span><span class="pun">=</span></li><li><a name="24"></a><span class="pln">		</span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">get_panel_info</span><span class="pun">();</span></li><li><a name="25"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">width </span><span class="pun">=</span></li><li><a name="26"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">width</span><span class="pun">;</span></li><li><a name="27"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">height </span><span class="pun">=</span></li><li><a name="28"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">height</span><span class="pun">;</span></li><li><a name="29"></a><span class="pun">}</span></li><li><a name="30"></a></li><li><a name="31"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> panel_id_reg_check</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> msm_fb_data_type </span><span class="pun">*</span><span class="pln">mfd</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> dsi_buf </span><span class="pun">*</span><span class="pln">ptx</span><span class="pun">,</span></li><li><a name="32"></a><span class="pln">			      </span><span class="kwd">struct</span><span class="pln"> dsi_buf </span><span class="pun">*</span><span class="pln">prx</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> panel_id</span><span class="pun">*</span><span class="pln"> panel</span><span class="pun">)</span></li><li><a name="33"></a><span class="pun">{</span></li><li><a name="34"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> i</span><span class="pun">;</span></li><li><a name="35"></a></li><li><a name="36"></a><span class="pln">	mutex_lock</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">dma</span><span class="pun">-&gt;</span><span class="pln">ov_mutex</span><span class="pun">);</span></li><li><a name="37"></a><span class="pln">	mipi_dsi_buf_init</span><span class="pun">(</span><span class="pln">prx</span><span class="pun">);</span></li><li><a name="38"></a><span class="pln">	mipi_dsi_buf_init</span><span class="pun">(</span><span class="pln">ptx</span><span class="pun">);</span></li><li><a name="39"></a><span class="pln">	mipi_dsi_cmds_rx</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">,</span><span class="pln"> ptx</span><span class="pun">,</span><span class="pln"> prx</span><span class="pun">,</span><span class="pln"> panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">read_id_cmds</span><span class="pun">,</span></li><li><a name="40"></a><span class="pln">			 panel</span><span class="pun">-&gt;</span><span class="pln">id_num</span><span class="pun">);</span></li><li><a name="41"></a><span class="pln">	mutex_unlock</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">dma</span><span class="pun">-&gt;</span><span class="pln">ov_mutex</span><span class="pun">);</span></li><li><a name="42"></a></li><li><a name="43"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> panel</span><span class="pun">-&gt;</span><span class="pln">id_num</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="44"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">i </span><span class="pun">&gt;=</span><span class="pln"> prx</span><span class="pun">-&gt;</span><span class="pln">len</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span></li><li><a name="45"></a><span class="pln">			</span><span class="pun">((</span><span class="pln">prx</span><span class="pun">-&gt;</span><span class="pln">data</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> panel</span><span class="pun">-&gt;</span><span class="pln">id</span><span class="pun">[</span><span class="pln">i</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&amp;&amp;</span></li><li><a name="46"></a><span class="pln">				</span><span class="pun">(</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">id</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">0xff</span><span class="pun">)))</span></li><li><a name="47"></a><span class="pln">			</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">ENODEV</span><span class="pun">;</span></li><li><a name="48"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="49"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="50"></a><span class="pun">}</span></li><li><a name="51"></a></li><li><a name="52"></a><span class="kwd">struct</span><span class="pln"> msm_panel_info </span><span class="pun">*</span><span class="pln">mipi_dsi_detect_panel</span><span class="pun">(</span></li><li><a name="53"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_fb_data_type </span><span class="pun">*</span><span class="pln">mfd</span><span class="pun">)</span></li><li><a name="54"></a><span class="pun">{</span></li><li><a name="55"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> i</span><span class="pun">;</span></li><li><a name="56"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> ret</span><span class="pun">;</span></li><li><a name="57"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="58"></a></li><li><a name="59"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">);</span></li><li><a name="60"></a></li><li><a name="61"></a><span class="pln">	mipi_dsi_op_mode_config</span><span class="pun">(</span><span class="pln">DSI_CMD_MODE</span><span class="pun">);</span></li><li><a name="62"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> NULL</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="63"></a><span class="pln">		</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="64"></a><span class="pln">			ret </span><span class="pun">=</span><span class="pln"> panel_id_reg_check</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">tx_buf</span><span class="pun">,</span></li><li><a name="65"></a><span class="pln">						 </span><span class="pun">&amp;</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">rx_buf</span><span class="pun">,</span></li><li><a name="66"></a><span class="pln">						 dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span></li><li><a name="67"></a><span class="pln">			</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">ret</span><span class="pun">)</span></li><li><a name="68"></a><span class="pln">				</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="69"></a><span class="pln">		</span><span class="pun">}</span></li><li><a name="70"></a></li><li><a name="71"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">])</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="72"></a><span class="pln">			dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">default_panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span></li><li><a name="73"></a><span class="pln">			dev_info</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="74"></a><span class="pln">				</span><span class="str">&quot;found panel vendor: %s\n&quot;</span><span class="pun">,</span></li><li><a name="75"></a><span class="pln">				dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">name</span><span class="pun">);</span></li><li><a name="76"></a><span class="pln">		</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="77"></a><span class="pln">			dev_warn</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="78"></a><span class="pln">				</span><span class="str">&quot;cannot detect panel vendor!\n&quot;</span><span class="pun">);</span></li><li><a name="79"></a><span class="pln">			</span><span class="kwd">return</span><span class="pln"> NULL</span><span class="pun">;</span></li><li><a name="80"></a><span class="pln">		</span><span class="pun">}</span></li><li><a name="81"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="82"></a></li><li><a name="83"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="84"></a><span class="pln">		ret </span><span class="pun">=</span><span class="pln"> panel_id_reg_check</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">tx_buf</span><span class="pun">,</span></li><li><a name="85"></a><span class="pln">					 </span><span class="pun">&amp;</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">rx_buf</span><span class="pun">,</span></li><li><a name="86"></a><span class="pln">					 dsi_data</span><span class="pun">-&gt;</span><span class="pln">panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">]);</span></li><li><a name="87"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">ret</span><span class="pun">)</span></li><li><a name="88"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="89"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="90"></a></li><li><a name="91"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">])</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="92"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span></li><li><a name="93"></a><span class="pln">		dev_info</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;found panel: %s\n&quot;</span><span class="pun">,</span></li><li><a name="94"></a><span class="pln">			 dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">name</span><span class="pun">);</span></li><li><a name="95"></a><span class="pln">	</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="96"></a><span class="pln">		dev_warn</span><span class="pun">(&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;cannot detect panel!\n&quot;</span><span class="pun">);</span></li><li><a name="97"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> NULL</span><span class="pun">;</span></li><li><a name="98"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="99"></a></li><li><a name="100"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info </span><span class="pun">=</span></li><li><a name="101"></a><span class="pln">		</span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">get_panel_info</span><span class="pun">();</span></li><li><a name="102"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">width </span><span class="pun">=</span></li><li><a name="103"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">width</span><span class="pun">;</span></li><li><a name="104"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">height </span><span class="pun">=</span></li><li><a name="105"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">height</span><span class="pun">;</span></li><li><a name="106"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">mipi</span><span class="pun">.</span><span class="pln">dsi_pclk_rate </span><span class="pun">=</span></li><li><a name="107"></a><span class="pln">		mfd</span><span class="pun">-&gt;</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">mipi</span><span class="pun">.</span><span class="pln">dsi_pclk_rate</span><span class="pun">;</span></li><li><a name="108"></a><span class="pln">	mipi_dsi_op_mode_config</span></li><li><a name="109"></a><span class="pln">		</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">mipi</span><span class="pun">.</span><span class="pln">mode</span><span class="pun">);</span></li><li><a name="110"></a></li><li><a name="111"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">;</span></li><li><a name="112"></a><span class="pun">}</span></li><li><a name="113"></a></li><li><a name="114"></a><span class="typ">int</span><span class="pln"> __devinit mipi_dsi_need_detect_panel</span><span class="pun">(</span></li><li><a name="115"></a><span class="pln">	</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> panel_id </span><span class="pun">**</span><span class="pln">panels</span><span class="pun">)</span></li><li><a name="116"></a><span class="pun">{</span></li><li><a name="117"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> num </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="118"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> i</span><span class="pun">;</span></li><li><a name="119"></a></li><li><a name="120"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> panels</span><span class="pun">[</span><span class="pln">i</span><span class="pun">];</span><span class="pln"> i</span><span class="pun">++)</span></li><li><a name="121"></a><span class="pln">		num</span><span class="pun">++;</span></li><li><a name="122"></a></li><li><a name="123"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">(</span><span class="pln">num </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">?</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="124"></a><span class="pun">}</span></li><li><a name="125"></a></li><li><a name="126"></a><span class="typ">int</span><span class="pln"> mipi_dsi_update_panel</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> platform_device </span><span class="pun">*</span><span class="pln">pdev</span><span class="pun">)</span></li><li><a name="127"></a><span class="pun">{</span></li><li><a name="128"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_fb_data_type </span><span class="pun">*</span><span class="pln">mfd</span><span class="pun">;</span></li><li><a name="129"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> fb_info </span><span class="pun">*</span><span class="pln">fbi</span><span class="pun">;</span></li><li><a name="130"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_panel_info </span><span class="pun">*</span><span class="pln">pinfo</span><span class="pun">;</span></li><li><a name="131"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_panel_info </span><span class="pun">*</span><span class="pln">mipi</span><span class="pun">;</span></li><li><a name="132"></a><span class="pln">	</span><span class="typ">uint8</span><span class="pln"> lanes </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">,</span><span class="pln"> bpp</span><span class="pun">;</span></li><li><a name="133"></a><span class="pln">	</span><span class="typ">uint32</span><span class="pln"> h_period</span><span class="pun">,</span><span class="pln"> v_period</span><span class="pun">,</span><span class="pln"> dsi_pclk_rate</span><span class="pun">;</span></li><li><a name="134"></a></li><li><a name="135"></a><span class="pln">	mfd </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="136"></a><span class="pln">	pinfo </span><span class="pun">=</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_info</span><span class="pun">;</span></li><li><a name="137"></a></li><li><a name="138"></a><span class="pln">	fbi </span><span class="pun">=</span><span class="pln"> mfd</span><span class="pun">-&gt;</span><span class="pln">fbi</span><span class="pun">;</span></li><li><a name="139"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">pixclock </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">clk_rate</span><span class="pun">;</span></li><li><a name="140"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">left_margin </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_back_porch</span><span class="pun">;</span></li><li><a name="141"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">right_margin </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_front_porch</span><span class="pun">;</span></li><li><a name="142"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">upper_margin </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_back_porch</span><span class="pun">;</span></li><li><a name="143"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">lower_margin </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_front_porch</span><span class="pun">;</span></li><li><a name="144"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">hsync_len </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_pulse_width</span><span class="pun">;</span></li><li><a name="145"></a><span class="pln">	fbi</span><span class="pun">-&gt;</span><span class="pln">var</span><span class="pun">.</span><span class="pln">vsync_len </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_pulse_width</span><span class="pun">;</span></li><li><a name="146"></a></li><li><a name="147"></a><span class="pln">	h_period </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_pulse_width</span><span class="pun">)</span></li><li><a name="148"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_back_porch</span><span class="pun">)</span></li><li><a name="149"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">xres</span><span class="pun">)</span></li><li><a name="150"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">h_front_porch</span><span class="pun">));</span></li><li><a name="151"></a></li><li><a name="152"></a><span class="pln">	v_period </span><span class="pun">=</span><span class="pln"> </span><span class="pun">((</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_pulse_width</span><span class="pun">)</span></li><li><a name="153"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_back_porch</span><span class="pun">)</span></li><li><a name="154"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">yres</span><span class="pun">)</span></li><li><a name="155"></a><span class="pln">			</span><span class="pun">+</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">lcdc</span><span class="pun">.</span><span class="pln">v_front_porch</span><span class="pun">));</span></li><li><a name="156"></a></li><li><a name="157"></a><span class="pln">	mipi  </span><span class="pun">=</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">mipi</span><span class="pun">;</span></li><li><a name="158"></a></li><li><a name="159"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">data_lane3</span><span class="pun">)</span></li><li><a name="160"></a><span class="pln">		lanes </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="161"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">data_lane2</span><span class="pun">)</span></li><li><a name="162"></a><span class="pln">		lanes </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="163"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">data_lane1</span><span class="pun">)</span></li><li><a name="164"></a><span class="pln">		lanes </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="165"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">data_lane0</span><span class="pun">)</span></li><li><a name="166"></a><span class="pln">		lanes </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">;</span></li><li><a name="167"></a></li><li><a name="168"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">dst_format </span><span class="pun">==</span><span class="pln"> DSI_CMD_DST_FORMAT_RGB888</span><span class="pun">)</span></li><li><a name="169"></a><span class="pln">	    </span><span class="pun">||</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">dst_format </span><span class="pun">==</span><span class="pln"> DSI_VIDEO_DST_FORMAT_RGB888</span><span class="pun">)</span></li><li><a name="170"></a><span class="pln">	    </span><span class="pun">||</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">dst_format </span><span class="pun">==</span><span class="pln"> DSI_VIDEO_DST_FORMAT_RGB666_LOOSE</span><span class="pun">))</span></li><li><a name="171"></a><span class="pln">		bpp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span></li><li><a name="172"></a><span class="pln">	</span><span class="kwd">else</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">dst_format </span><span class="pun">==</span><span class="pln"> DSI_CMD_DST_FORMAT_RGB565</span><span class="pun">)</span></li><li><a name="173"></a><span class="pln">		 </span><span class="pun">||</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">dst_format </span><span class="pun">==</span><span class="pln"> DSI_VIDEO_DST_FORMAT_RGB565</span><span class="pun">))</span></li><li><a name="174"></a><span class="pln">		bpp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">2</span><span class="pun">;</span></li><li><a name="175"></a><span class="pln">	</span><span class="kwd">else</span></li><li><a name="176"></a><span class="pln">		bpp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">3</span><span class="pun">;</span><span class="pln">		</span><span class="com">/* Default format set to RGB888 */</span></li><li><a name="177"></a></li><li><a name="178"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">pinfo</span><span class="pun">-&gt;</span><span class="pln">type </span><span class="pun">==</span><span class="pln"> MIPI_VIDEO_PANEL</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="179"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">lanes </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="180"></a><span class="pln">			pinfo</span><span class="pun">-&gt;</span><span class="pln">clk_rate </span><span class="pun">=</span></li><li><a name="181"></a><span class="pln">			</span><span class="pun">((</span><span class="pln">h_period </span><span class="pun">*</span><span class="pln"> v_period </span><span class="pun">*</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">frame_rate</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> bpp </span><span class="pun">*</span><span class="pln"> </span><span class="lit">8</span><span class="pun">)</span></li><li><a name="182"></a><span class="pln">			   </span><span class="pun">/</span><span class="pln"> lanes</span><span class="pun">);</span></li><li><a name="183"></a><span class="pln">		</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="184"></a><span class="pln">			pr_err</span><span class="pun">(</span><span class="str">&quot;%s: forcing mipi_dsi lanes to 1\n&quot;</span><span class="pun">,</span><span class="pln"> __func__</span><span class="pun">);</span></li><li><a name="185"></a><span class="pln">			pinfo</span><span class="pun">-&gt;</span><span class="pln">clk_rate </span><span class="pun">=</span></li><li><a name="186"></a><span class="pln">				</span><span class="pun">(</span><span class="pln">h_period </span><span class="pun">*</span><span class="pln"> v_period</span></li><li><a name="187"></a><span class="pln">					 </span><span class="pun">*</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mipi</span><span class="pun">-&gt;</span><span class="pln">frame_rate</span><span class="pun">)</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> bpp </span><span class="pun">*</span><span class="pln"> </span><span class="lit">8</span><span class="pun">);</span></li><li><a name="188"></a><span class="pln">		</span><span class="pun">}</span></li><li><a name="189"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="190"></a><span class="pln">	pll_divider_config</span><span class="pun">.</span><span class="pln">clk_rate </span><span class="pun">=</span><span class="pln"> pinfo</span><span class="pun">-&gt;</span><span class="pln">clk_rate</span><span class="pun">;</span></li><li><a name="191"></a></li><li><a name="192"></a><span class="pln">	mipi_dsi_clk_div_config</span><span class="pun">(</span><span class="pln">bpp</span><span class="pun">,</span><span class="pln"> lanes</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dsi_pclk_rate</span><span class="pun">);</span></li><li><a name="193"></a></li><li><a name="194"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">((</span><span class="pln">dsi_pclk_rate </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">3300000</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_pclk_rate </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">103300000</span><span class="pun">))</span></li><li><a name="195"></a><span class="pln">		dsi_pclk_rate </span><span class="pun">=</span><span class="pln"> </span><span class="lit">35000000</span><span class="pun">;</span></li><li><a name="196"></a><span class="pln">	mipi</span><span class="pun">-&gt;</span><span class="pln">dsi_pclk_rate </span><span class="pun">=</span><span class="pln"> dsi_pclk_rate</span><span class="pun">;</span></li><li><a name="197"></a></li><li><a name="198"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="199"></a><span class="pun">}</span></li><li><a name="200"></a></li><li><a name="201"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">ssize_t</span><span class="pln"> show_eco_mode</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> device </span><span class="pun">*</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="202"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> device_attribute </span><span class="pun">*</span><span class="pln">attr</span><span class="pun">,</span></li><li><a name="203"></a><span class="pln">	</span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buf</span><span class="pun">)</span></li><li><a name="204"></a><span class="pun">{</span></li><li><a name="205"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> platform_device </span><span class="pun">*</span><span class="pln">pdev</span><span class="pun">;</span></li><li><a name="206"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="207"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_fb_data_type </span><span class="pun">*</span><span class="pln">mfd</span><span class="pun">;</span></li><li><a name="208"></a></li><li><a name="209"></a><span class="pln">	pdev </span><span class="pun">=</span><span class="pln"> container_of</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> platform_device</span><span class="pun">,</span><span class="pln"> dev</span><span class="pun">);</span></li><li><a name="210"></a><span class="pln">	mfd </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="211"></a></li><li><a name="212"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">);</span></li><li><a name="213"></a></li><li><a name="214"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> snprintf</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> PAGE_SIZE</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;%i\n&quot;</span><span class="pun">,</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">eco_mode_on</span><span class="pun">);</span></li><li><a name="215"></a><span class="pun">}</span></li><li><a name="216"></a></li><li><a name="217"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">ssize_t</span><span class="pln"> store_eco_mode</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> device </span><span class="pun">*</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="218"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> device_attribute </span><span class="pun">*</span><span class="pln">attr</span><span class="pun">,</span></li><li><a name="219"></a><span class="pln">	</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">buf</span><span class="pun">,</span></li><li><a name="220"></a><span class="pln">	</span><span class="typ">size_t</span><span class="pln"> count</span><span class="pun">)</span></li><li><a name="221"></a><span class="pun">{</span></li><li><a name="222"></a><span class="pln">	</span><span class="typ">ssize_t</span><span class="pln"> ret</span><span class="pun">;</span></li><li><a name="223"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> platform_device </span><span class="pun">*</span><span class="pln">pdev</span><span class="pun">;</span></li><li><a name="224"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="225"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_fb_data_type </span><span class="pun">*</span><span class="pln">mfd</span><span class="pun">;</span></li><li><a name="226"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> msm_fb_panel_data </span><span class="pun">*</span><span class="pln">pdata </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">;</span></li><li><a name="227"></a></li><li><a name="228"></a><span class="pln">	pdev </span><span class="pun">=</span><span class="pln"> container_of</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> platform_device</span><span class="pun">,</span><span class="pln"> dev</span><span class="pun">);</span></li><li><a name="229"></a><span class="pln">	mfd </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="230"></a></li><li><a name="231"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_pdev</span><span class="pun">);</span></li><li><a name="232"></a></li><li><a name="233"></a><span class="pln">	pdata </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> msm_fb_panel_data </span><span class="pun">*)</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">.</span><span class="pln">platform_data</span><span class="pun">;</span></li><li><a name="234"></a></li><li><a name="235"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">sscanf</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;%i&quot;</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">ret</span><span class="pun">)</span><span class="pln"> </span><span class="pun">!=</span><span class="pln"> </span><span class="lit">1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="236"></a><span class="pln">		printk</span><span class="pun">(</span><span class="pln">KERN_ERR</span><span class="str">&quot;Invalid flag for eco_mode\n&quot;</span><span class="pun">);</span></li><li><a name="237"></a><span class="pln">		</span><span class="kwd">goto</span><span class="pln"> exit</span><span class="pun">;</span></li><li><a name="238"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="239"></a></li><li><a name="240"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ret</span><span class="pun">)</span></li><li><a name="241"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">eco_mode_on </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">;</span></li><li><a name="242"></a><span class="pln">	</span><span class="kwd">else</span></li><li><a name="243"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">eco_mode_on </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">;</span></li><li><a name="244"></a></li><li><a name="245"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="246"></a><span class="pln">		</span><span class="typ">int</span><span class="pln"> curr_pwr_state</span><span class="pun">;</span></li><li><a name="247"></a></li><li><a name="248"></a><span class="pln">		mfd</span><span class="pun">-&gt;</span><span class="pln">op_enable </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li><a name="249"></a><span class="pln">		curr_pwr_state </span><span class="pun">=</span><span class="pln"> mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on</span><span class="pun">;</span></li><li><a name="250"></a><span class="pln">		mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on </span><span class="pun">=</span><span class="pln"> FALSE</span><span class="pun">;</span></li><li><a name="251"></a></li><li><a name="252"></a><span class="pln">		msleep</span><span class="pun">(</span><span class="pln">ONE_FRAME_TRANSMIT_WAIT_MS</span><span class="pun">);</span></li><li><a name="253"></a><span class="pln">		ret </span><span class="pun">=</span><span class="pln"> pdata</span><span class="pun">-&gt;</span><span class="pln">off</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="254"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ret</span><span class="pun">)</span></li><li><a name="255"></a><span class="pln">			mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on </span><span class="pun">=</span><span class="pln"> curr_pwr_state</span><span class="pun">;</span></li><li><a name="256"></a></li><li><a name="257"></a><span class="pln">		mfd</span><span class="pun">-&gt;</span><span class="pln">op_enable </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li><a name="258"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="259"></a></li><li><a name="260"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="261"></a><span class="pln">		pdata</span><span class="pun">-&gt;</span><span class="pln">on</span><span class="pun">(</span><span class="pln">mfd</span><span class="pun">-&gt;</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="262"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">ret </span><span class="pun">==</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li><a name="263"></a><span class="pln">			mfd</span><span class="pun">-&gt;</span><span class="pln">panel_power_on </span><span class="pun">=</span><span class="pln"> TRUE</span><span class="pun">;</span></li><li><a name="264"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="265"></a></li><li><a name="266"></a><span class="pln">exit</span><span class="pun">:</span></li><li><a name="267"></a><span class="pln">	ret </span><span class="pun">=</span><span class="pln"> strnlen</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> count</span><span class="pun">);</span></li><li><a name="268"></a></li><li><a name="269"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> ret</span><span class="pun">;</span></li><li><a name="270"></a><span class="pun">}</span></li><li><a name="271"></a></li><li><a name="272"></a><span class="kwd">static</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> device_attribute eco_mode_attributes</span><span class="pun">[]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="273"></a><span class="pln">	__ATTR</span><span class="pun">(</span><span class="pln">eco_mode</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0644</span><span class="pun">,</span><span class="pln"> show_eco_mode</span><span class="pun">,</span><span class="pln"> store_eco_mode</span><span class="pun">),</span></li><li><a name="274"></a><span class="pun">};</span></li><li><a name="275"></a></li><li><a name="276"></a><span class="typ">int</span><span class="pln"> eco_mode_sysfs_register</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> device </span><span class="pun">*</span><span class="pln">dev</span><span class="pun">)</span></li><li><a name="277"></a><span class="pun">{</span></li><li><a name="278"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> i</span><span class="pun">;</span></li><li><a name="279"></a></li><li><a name="280"></a><span class="pln">	dev_dbg</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;%s\n&quot;</span><span class="pun">,</span><span class="pln"> __func__</span><span class="pun">);</span></li><li><a name="281"></a></li><li><a name="282"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> ARRAY_SIZE</span><span class="pun">(</span><span class="pln">eco_mode_attributes</span><span class="pun">);</span><span class="pln"> i</span><span class="pun">++)</span></li><li><a name="283"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">device_create_file</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> eco_mode_attributes </span><span class="pun">+</span><span class="pln"> i</span><span class="pun">))</span></li><li><a name="284"></a><span class="pln">			</span><span class="kwd">goto</span><span class="pln"> error</span><span class="pun">;</span></li><li><a name="285"></a></li><li><a name="286"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="287"></a></li><li><a name="288"></a><span class="pln">error</span><span class="pun">:</span></li><li><a name="289"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(;</span><span class="pln"> i </span><span class="pun">&gt;=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">--)</span></li><li><a name="290"></a><span class="pln">		device_remove_file</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> eco_mode_attributes </span><span class="pun">+</span><span class="pln"> i</span><span class="pun">);</span></li><li><a name="291"></a></li><li><a name="292"></a><span class="pln">	dev_err</span><span class="pun">(</span><span class="pln">dev</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;%s: Unable to create interface\n&quot;</span><span class="pun">,</span><span class="pln"> __func__</span><span class="pun">);</span></li><li><a name="293"></a></li><li><a name="294"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">ENODEV</span><span class="pun">;</span></li><li><a name="295"></a><span class="pun">}</span></li><li><a name="296"></a></li><li><a name="297"></a><span class="com">#ifdef</span><span class="pln"> CONFIG_DEBUG_FS</span></li><li><a name="298"></a></li><li><a name="299"></a><span class="com">#define</span><span class="pln"> MIPI_PANEL_DEBUG_BUF	</span><span class="lit">2048</span></li><li><a name="300"></a></li><li><a name="301"></a><span class="com">#define</span><span class="pln"> MSNPRINTF</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> rsize</span><span class="pun">,</span><span class="pln"> </span><span class="pun">...)</span><span class="pln">			\</span></li><li><a name="302"></a><span class="kwd">do</span><span class="pln"> </span><span class="pun">{</span><span class="pln">							\</span></li><li><a name="303"></a><span class="pln">	</span><span class="typ">ssize_t</span><span class="pln"> act </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln">					\</span></li><li><a name="304"></a><span class="pln">							\</span></li><li><a name="305"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">rsize </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span><span class="pln">					\</span></li><li><a name="306"></a><span class="pln">		act </span><span class="pun">=</span><span class="pln"> snprintf</span><span class="pun">(</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> rsize</span><span class="pun">,</span><span class="pln"> __VA_ARGS__</span><span class="pun">);</span><span class="pln">	\</span></li><li><a name="307"></a><span class="pln">	buf </span><span class="pun">+=</span><span class="pln"> act</span><span class="pun">;</span><span class="pln">					\</span></li><li><a name="308"></a><span class="pln">	rsize </span><span class="pun">-=</span><span class="pln"> act</span><span class="pun">;</span><span class="pln">					\</span></li><li><a name="309"></a><span class="pun">}</span><span class="pln"> </span><span class="kwd">while</span><span class="pln"> </span><span class="pun">(</span><span class="lit">0</span><span class="pun">)</span></li><li><a name="310"></a></li><li><a name="311"></a><span class="kwd">static</span><span class="pln"> </span><span class="kwd">void</span><span class="pln"> print_cmds2buf</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> dsi_cmd_desc </span><span class="pun">*</span><span class="pln">cmds</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> cnt</span><span class="pun">,</span></li><li><a name="312"></a><span class="pln">			 </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">**</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">)</span></li><li><a name="313"></a><span class="pun">{</span></li><li><a name="314"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> i</span><span class="pun">,</span><span class="pln"> j</span><span class="pun">;</span></li><li><a name="315"></a></li><li><a name="316"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">cmds</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="317"></a><span class="pln">		MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;cmds NULL\n&quot;</span><span class="pun">);</span></li><li><a name="318"></a><span class="pln">		</span><span class="kwd">goto</span><span class="pln"> exit</span><span class="pun">;</span></li><li><a name="319"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="320"></a></li><li><a name="321"></a><span class="pln">	</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">i </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> i </span><span class="pun">&lt;</span><span class="pln"> cnt</span><span class="pun">;</span><span class="pln"> i</span><span class="pun">++)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="322"></a><span class="pln">		</span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">cmds</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">dtype</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="323"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_DCS_WRITE</span><span class="pun">:</span></li><li><a name="324"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_DCS_WRITE1</span><span class="pun">:</span></li><li><a name="325"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;DCS_WRITE: &quot;</span><span class="pun">);</span></li><li><a name="326"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="327"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_DCS_LWRITE</span><span class="pun">:</span></li><li><a name="328"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;DCS_LONG_WRITE: &quot;</span><span class="pun">);</span></li><li><a name="329"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="330"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_WRITE</span><span class="pun">:</span></li><li><a name="331"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_WRITE1</span><span class="pun">:</span></li><li><a name="332"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_WRITE2</span><span class="pun">:</span></li><li><a name="333"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;GEN_WRITE: &quot;</span><span class="pun">);</span></li><li><a name="334"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="335"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_LWRITE</span><span class="pun">:</span></li><li><a name="336"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;GEN_LONG_WRITE: &quot;</span><span class="pun">);</span></li><li><a name="337"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="338"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_DCS_READ</span><span class="pun">:</span></li><li><a name="339"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;DCS_READ: &quot;</span><span class="pun">);</span></li><li><a name="340"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="341"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_READ</span><span class="pun">:</span></li><li><a name="342"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_READ1</span><span class="pun">:</span></li><li><a name="343"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_GEN_READ2</span><span class="pun">:</span></li><li><a name="344"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;GEN_READ: &quot;</span><span class="pun">);</span></li><li><a name="345"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="346"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_MAX_PKTSIZE</span><span class="pun">:</span></li><li><a name="347"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;SET_MAX_PACKET_SIZE: &quot;</span><span class="pun">);</span></li><li><a name="348"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="349"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_NULL_PKT</span><span class="pun">:</span></li><li><a name="350"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;NULL_PACKET: &quot;</span><span class="pun">);</span></li><li><a name="351"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="352"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_BLANK_PKT</span><span class="pun">:</span></li><li><a name="353"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;BLANK_PACKET: &quot;</span><span class="pun">);</span></li><li><a name="354"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="355"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_PERIPHERAL_ON</span><span class="pun">:</span></li><li><a name="356"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;PERIPHERAL_ON: &quot;</span><span class="pun">);</span></li><li><a name="357"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="358"></a><span class="pln">		</span><span class="kwd">case</span><span class="pln"> DTYPE_PERIPHERAL_OFF</span><span class="pun">:</span></li><li><a name="359"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;PERIPHERAL_OFF: &quot;</span><span class="pun">);</span></li><li><a name="360"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="361"></a><span class="pln">		</span><span class="kwd">default</span><span class="pun">:</span></li><li><a name="362"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;UnknownData: &quot;</span><span class="pun">);</span></li><li><a name="363"></a><span class="pln">			</span><span class="kwd">break</span><span class="pun">;</span></li><li><a name="364"></a><span class="pln">		</span><span class="pun">}</span></li><li><a name="365"></a><span class="pln">		</span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">j </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span><span class="pln"> j </span><span class="pun">&lt;</span><span class="pln"> cmds</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">dlen</span><span class="pun">;</span><span class="pln"> j</span><span class="pun">++)</span></li><li><a name="366"></a><span class="pln">			MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;0x%.2x &quot;</span><span class="pun">,</span></li><li><a name="367"></a><span class="pln">				  cmds</span><span class="pun">[</span><span class="pln">i</span><span class="pun">].</span><span class="pln">payload</span><span class="pun">[</span><span class="pln">j</span><span class="pun">]);</span></li><li><a name="368"></a><span class="pln">		MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;\n&quot;</span><span class="pun">);</span></li><li><a name="369"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="370"></a><span class="pln">	MSNPRINTF</span><span class="pun">(*</span><span class="pln">buf</span><span class="pun">,</span><span class="pln"> </span><span class="pun">*</span><span class="pln">rem_size</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;---------\n&quot;</span><span class="pun">);</span></li><li><a name="371"></a><span class="pln">exit</span><span class="pun">:</span></li><li><a name="372"></a><span class="pln">	</span><span class="kwd">return</span><span class="pun">;</span></li><li><a name="373"></a><span class="pun">}</span></li><li><a name="374"></a></li><li><a name="375"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> mipi_dsi_cmd_seq_open</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> inode </span><span class="pun">*</span><span class="pln">inode</span><span class="pun">,</span></li><li><a name="376"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> file </span><span class="pun">*</span><span class="pln">file</span><span class="pun">)</span></li><li><a name="377"></a><span class="pun">{</span></li><li><a name="378"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="379"></a></li><li><a name="380"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> inode</span><span class="pun">-&gt;</span><span class="pln">i_private</span><span class="pun">;</span></li><li><a name="381"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf </span><span class="pun">!=</span><span class="pln"> NULL</span><span class="pun">)</span></li><li><a name="382"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">EBUSY</span><span class="pun">;</span></li><li><a name="383"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf </span><span class="pun">=</span><span class="pln"> kzalloc</span><span class="pun">(</span><span class="pln">MIPI_PANEL_DEBUG_BUF</span><span class="pun">,</span><span class="pln"> GFP_KERNEL</span><span class="pun">);</span></li><li><a name="384"></a><span class="pln">	file</span><span class="pun">-&gt;</span><span class="pln">private_data </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">;</span></li><li><a name="385"></a><span class="pln">	</span><span class="com">/* non-seekable */</span></li><li><a name="386"></a><span class="pln">	file</span><span class="pun">-&gt;</span><span class="pln">f_mode </span><span class="pun">&amp;=</span><span class="pln"> </span><span class="pun">~(</span><span class="pln">FMODE_LSEEK </span><span class="pun">|</span><span class="pln"> FMODE_PREAD </span><span class="pun">|</span><span class="pln"> FMODE_PWRITE</span><span class="pun">);</span></li><li><a name="387"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="388"></a><span class="pun">}</span></li><li><a name="389"></a></li><li><a name="390"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">int</span><span class="pln"> mipi_dsi_cmd_seq_release</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> inode </span><span class="pun">*</span><span class="pln">inode</span><span class="pun">,</span></li><li><a name="391"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> file </span><span class="pun">*</span><span class="pln">file</span><span class="pun">)</span></li><li><a name="392"></a><span class="pun">{</span></li><li><a name="393"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="394"></a></li><li><a name="395"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> file</span><span class="pun">-&gt;</span><span class="pln">private_data</span><span class="pun">;</span></li><li><a name="396"></a><span class="pln">	kfree</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf</span><span class="pun">);</span></li><li><a name="397"></a><span class="pln">	dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf </span><span class="pun">=</span><span class="pln"> NULL</span><span class="pun">;</span></li><li><a name="398"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="399"></a><span class="pun">}</span></li><li><a name="400"></a></li><li><a name="401"></a><span class="kwd">static</span><span class="pln"> </span><span class="typ">ssize_t</span><span class="pln"> mipi_dsi_cmd_seq_read</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> file </span><span class="pun">*</span><span class="pln">file</span><span class="pun">,</span></li><li><a name="402"></a><span class="pln">	</span><span class="kwd">char</span><span class="pln"> __user </span><span class="pun">*</span><span class="pln">buff</span><span class="pun">,</span><span class="pln"> </span><span class="typ">size_t</span><span class="pln"> count</span><span class="pun">,</span><span class="pln"> </span><span class="typ">loff_t</span><span class="pln"> </span><span class="pun">*</span><span class="pln">ppos</span><span class="pun">)</span></li><li><a name="403"></a><span class="pun">{</span></li><li><a name="404"></a><span class="pln">	</span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">bp</span><span class="pun">;</span></li><li><a name="405"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> len </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="406"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> tot </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="407"></a><span class="pln">	</span><span class="typ">int</span><span class="pln"> dlen</span><span class="pun">;</span></li><li><a name="408"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="409"></a></li><li><a name="410"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(*</span><span class="pln">ppos</span><span class="pun">)</span></li><li><a name="411"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="412"></a></li><li><a name="413"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> file</span><span class="pun">-&gt;</span><span class="pln">private_data</span><span class="pun">;</span></li><li><a name="414"></a></li><li><a name="415"></a><span class="pln">	bp </span><span class="pun">=</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf</span><span class="pun">;</span></li><li><a name="416"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">bp </span><span class="pun">==</span><span class="pln"> NULL</span><span class="pun">)</span></li><li><a name="417"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="418"></a></li><li><a name="419"></a><span class="pln">	dlen </span><span class="pun">=</span><span class="pln"> MIPI_PANEL_DEBUG_BUF</span><span class="pun">;</span></li><li><a name="420"></a></li><li><a name="421"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="422"></a><span class="pln">		</span><span class="com">/* show panel info */</span></li><li><a name="423"></a><span class="pln">		MSNPRINTF</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;Register data for panel %s\n&quot;</span><span class="pun">,</span></li><li><a name="424"></a><span class="pln">			  dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">name</span><span class="pun">);</span></li><li><a name="425"></a><span class="pln">		MSNPRINTF</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;xres = %d, yres = %d\n&quot;</span><span class="pun">,</span></li><li><a name="426"></a><span class="pln">			  dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">xres</span><span class="pun">,</span></li><li><a name="427"></a><span class="pln">			  dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_data</span><span class="pun">.</span><span class="pln">panel_info</span><span class="pun">.</span><span class="pln">yres</span><span class="pun">);</span></li><li><a name="428"></a><span class="pln">		</span><span class="com">/* show commands */</span></li><li><a name="429"></a><span class="pln">		MSNPRINTF</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;init cmds:\n&quot;</span><span class="pun">);</span></li><li><a name="430"></a><span class="pln">		print_cmds2buf</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_init_cmds</span><span class="pun">,</span></li><li><a name="431"></a><span class="pln">			     dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_init_cmds_size</span><span class="pun">,</span></li><li><a name="432"></a><span class="pln">			       </span><span class="pun">&amp;</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dlen</span><span class="pun">);</span></li><li><a name="433"></a><span class="pln">		MSNPRINTF</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;display_on cmds:\n&quot;</span><span class="pun">);</span></li><li><a name="434"></a><span class="pln">		print_cmds2buf</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_on_cmds</span><span class="pun">,</span></li><li><a name="435"></a><span class="pln">			     dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_on_cmds_size</span><span class="pun">,</span></li><li><a name="436"></a><span class="pln">			       </span><span class="pun">&amp;</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dlen</span><span class="pun">);</span></li><li><a name="437"></a><span class="pln">		MSNPRINTF</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;display_off cmds:\n&quot;</span><span class="pun">);</span></li><li><a name="438"></a><span class="pln">		print_cmds2buf</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_off_cmds</span><span class="pun">,</span></li><li><a name="439"></a><span class="pln">			     dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel</span><span class="pun">-&gt;</span><span class="pln">pctrl</span><span class="pun">-&gt;</span><span class="pln">display_off_cmds_size</span><span class="pun">,</span></li><li><a name="440"></a><span class="pln">			       </span><span class="pun">&amp;</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> </span><span class="pun">&amp;</span><span class="pln">dlen</span><span class="pun">);</span></li><li><a name="441"></a><span class="pln">	</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="442"></a><span class="pln">		len </span><span class="pun">=</span><span class="pln"> snprintf</span><span class="pun">(</span><span class="pln">bp</span><span class="pun">,</span><span class="pln"> dlen</span><span class="pun">,</span><span class="pln"> </span><span class="str">&quot;No panel name\n&quot;</span><span class="pun">);</span></li><li><a name="443"></a><span class="pln">		bp </span><span class="pun">+=</span><span class="pln"> len</span><span class="pun">;</span></li><li><a name="444"></a><span class="pln">		dlen </span><span class="pun">-=</span><span class="pln"> len</span><span class="pun">;</span></li><li><a name="445"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="446"></a></li><li><a name="447"></a><span class="pln">	tot </span><span class="pun">=</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint32</span><span class="pun">)</span><span class="pln">bp </span><span class="pun">-</span><span class="pln"> </span><span class="pun">(</span><span class="typ">uint32</span><span class="pun">)</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf</span><span class="pun">;</span></li><li><a name="448"></a><span class="pln">	</span><span class="pun">*</span><span class="pln">bp </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="449"></a><span class="pln">	tot</span><span class="pun">++;</span></li><li><a name="450"></a></li><li><a name="451"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">tot </span><span class="pun">&lt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">)</span></li><li><a name="452"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> </span><span class="lit">0</span><span class="pun">;</span></li><li><a name="453"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">copy_to_user</span><span class="pun">(</span><span class="pln">buff</span><span class="pun">,</span><span class="pln"> dsi_data</span><span class="pun">-&gt;</span><span class="pln">debug_buf</span><span class="pun">,</span><span class="pln"> tot</span><span class="pun">))</span></li><li><a name="454"></a><span class="pln">		</span><span class="kwd">return</span><span class="pln"> </span><span class="pun">-</span><span class="pln">EFAULT</span><span class="pun">;</span></li><li><a name="455"></a></li><li><a name="456"></a><span class="pln">	</span><span class="pun">*</span><span class="pln">ppos </span><span class="pun">+=</span><span class="pln"> tot</span><span class="pun">;</span></li><li><a name="457"></a></li><li><a name="458"></a><span class="pln">	</span><span class="kwd">return</span><span class="pln"> tot</span><span class="pun">;</span></li><li><a name="459"></a><span class="pun">}</span></li><li><a name="460"></a></li><li><a name="461"></a><span class="kwd">static</span><span class="pln"> </span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">struct</span><span class="pln"> file_operations mipi_dsi_cmd_seq_fops </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="462"></a><span class="pln">	</span><span class="pun">.</span><span class="pln">open </span><span class="pun">=</span><span class="pln"> mipi_dsi_cmd_seq_open</span><span class="pun">,</span></li><li><a name="463"></a><span class="pln">	</span><span class="pun">.</span><span class="pln">release </span><span class="pun">=</span><span class="pln"> mipi_dsi_cmd_seq_release</span><span class="pun">,</span></li><li><a name="464"></a><span class="pln">	</span><span class="pun">.</span><span class="pln">read </span><span class="pun">=</span><span class="pln"> mipi_dsi_cmd_seq_read</span><span class="pun">,</span></li><li><a name="465"></a><span class="pun">};</span></li><li><a name="466"></a></li><li><a name="467"></a><span class="kwd">void</span><span class="pln"> mipi_dsi_debugfs_init</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> platform_device </span><span class="pun">*</span><span class="pln">pdev</span><span class="pun">,</span></li><li><a name="468"></a><span class="pln">	</span><span class="kwd">const</span><span class="pln"> </span><span class="kwd">char</span><span class="pln"> </span><span class="pun">*</span><span class="pln">sub_name</span><span class="pun">)</span></li><li><a name="469"></a><span class="pun">{</span></li><li><a name="470"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> dentry </span><span class="pun">*</span><span class="pln">root</span><span class="pun">;</span></li><li><a name="471"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> dentry </span><span class="pun">*</span><span class="pln">file</span><span class="pun">;</span></li><li><a name="472"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="473"></a></li><li><a name="474"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="475"></a><span class="pln">	root </span><span class="pun">=</span><span class="pln"> msm_fb_get_debugfs_root</span><span class="pun">();</span></li><li><a name="476"></a><span class="pln">	</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">root </span><span class="pun">!=</span><span class="pln"> NULL</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="477"></a><span class="pln">		dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir </span><span class="pun">=</span></li><li><a name="478"></a><span class="pln">			debugfs_create_dir</span><span class="pun">(</span><span class="pln">sub_name</span><span class="pun">,</span><span class="pln"> root</span><span class="pun">);</span></li><li><a name="479"></a></li><li><a name="480"></a><span class="pln">		</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">IS_ERR</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span></li><li><a name="481"></a><span class="pln">			</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir </span><span class="pun">==</span><span class="pln"> NULL</span><span class="pun">))</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="482"></a><span class="pln">			dev_err</span><span class="pun">(&amp;</span><span class="pln">pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="483"></a><span class="pln">				</span><span class="str">&quot;debugfs_create_dir fail, error %ld\n&quot;</span><span class="pun">,</span></li><li><a name="484"></a><span class="pln">				PTR_ERR</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir</span><span class="pun">));</span></li><li><a name="485"></a><span class="pln">		</span><span class="pun">}</span><span class="pln"> </span><span class="kwd">else</span><span class="pln"> </span><span class="pun">{</span></li><li><a name="486"></a><span class="pln">			file </span><span class="pun">=</span><span class="pln"> debugfs_create_file</span><span class="pun">(</span><span class="str">&quot;cmd_seq&quot;</span><span class="pun">,</span><span class="pln"> </span><span class="lit">0444</span><span class="pun">,</span></li><li><a name="487"></a><span class="pln">				dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir</span><span class="pun">,</span><span class="pln"> dsi_data</span><span class="pun">,</span></li><li><a name="488"></a><span class="pln">				</span><span class="pun">&amp;</span><span class="pln">mipi_dsi_cmd_seq_fops</span><span class="pun">);</span></li><li><a name="489"></a><span class="pln">			</span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file </span><span class="pun">==</span><span class="pln"> NULL</span><span class="pun">)</span></li><li><a name="490"></a><span class="pln">				dev_err</span><span class="pun">(&amp;</span><span class="pln">pdev</span><span class="pun">-&gt;</span><span class="pln">dev</span><span class="pun">,</span></li><li><a name="491"></a><span class="pln">					</span><span class="str">&quot;debugfs_create_file: index fail\n&quot;</span><span class="pun">);</span></li><li><a name="492"></a><span class="pln">		</span><span class="pun">}</span></li><li><a name="493"></a><span class="pln">	</span><span class="pun">}</span></li><li><a name="494"></a><span class="pun">}</span></li><li><a name="495"></a></li><li><a name="496"></a><span class="kwd">void</span><span class="pln"> mipi_dsi_debugfs_exit</span><span class="pun">(</span><span class="kwd">struct</span><span class="pln"> platform_device </span><span class="pun">*</span><span class="pln">pdev</span><span class="pun">)</span></li><li><a name="497"></a><span class="pun">{</span></li><li><a name="498"></a><span class="pln">	</span><span class="kwd">struct</span><span class="pln"> mipi_dsi_data </span><span class="pun">*</span><span class="pln">dsi_data</span><span class="pun">;</span></li><li><a name="499"></a></li><li><a name="500"></a><span class="pln">	dsi_data </span><span class="pun">=</span><span class="pln"> platform_get_drvdata</span><span class="pun">(</span><span class="pln">pdev</span><span class="pun">);</span></li><li><a name="501"></a><span class="pln">	debugfs_remove_recursive</span><span class="pun">(</span><span class="pln">dsi_data</span><span class="pun">-&gt;</span><span class="pln">panel_driver_ic_dir</span><span class="pun">);</span></li><li><a name="502"></a><span class="pun">}</span></li><li><a name="503"></a></li><li><a name="504"></a><span class="com">#endif</span><span class="pln"> </span><span class="com">/* CONFIG_DEBUG_FS */</span></li></ol><div class="footer">Powered by <a href="https://code.google.com/p/gitiles/">Gitiles</a></div></body></html>